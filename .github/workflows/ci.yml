name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install black ruff pytest
    
    - name: Check Python syntax (compileall)
      run: |
        python -m compileall gateway
    
    - name: Run linter (ruff)
      run: |
        ruff check gateway
    
    - name: Check formatting (black)
      run: |
        black --check gateway
    
    - name: Run tests
      run: |
        pytest -q
      env:
        PYTHONPATH: ${{ github.workspace }}
        ENV: TEST
        DISABLE_RATE_LIMITS: "1"

  postgres-verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: cdil
          POSTGRES_USER: cdil
          POSTGRES_PASSWORD: cdil
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psycopg2-binary

    - name: Apply Postgres schema via Alembic
      run: |
        alembic upgrade head
      env:
        DATABASE_URL: postgresql+psycopg2://cdil:cdil@localhost:5432/cdil
        PYTHONPATH: ${{ github.workspace }}

    - name: Verify schema objects exist
      run: |
        psql "$PG_URL" -c "\d audit_events" | grep -q event_hash
        echo "Schema verification: audit_events table with event_hash column confirmed."
      env:
        PG_URL: postgresql://cdil:cdil@localhost:5432/cdil

    - name: Seed audit events via canonical writer path (hashes via ledger_hashing)
      run: |
        # NOTE: The production create_audit_event writer uses sqlite3.
        # Direct SQL inserts are used here for Postgres CI seeding because the
        # writer has no Postgres backend yet.  All hashes are computed only
        # through gateway.app.db.ledger_hashing.compute_event_hash.
        python3 - <<'EOF'
        import json, os, sys, uuid
        from datetime import datetime, timezone
        sys.path.insert(0, ".")
        import psycopg2
        from gateway.app.db.ledger_hashing import compute_event_hash

        pg_url = os.environ["PGURL"]
        conn = psycopg2.connect(pg_url)
        cur = conn.cursor()
        tenant_id = "tenant_ci_test"
        prev_hash = None
        for i in range(3):
            event_id = str(uuid.uuid4())
            ts = datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")
            obj_type, obj_id, action = "note", f"note_{i}", "create"
            payload = json.dumps({"step": i})
            event_hash = compute_event_hash(
                prev_hash, ts, obj_type, obj_id, action, payload
            )
            cur.execute(
                """
                INSERT INTO audit_events (
                    event_id, tenant_id, occurred_at_utc, actor_id,
                    object_type, object_id, action, event_payload_json,
                    prev_event_hash, event_hash
                ) VALUES (%s,%s,%s,NULL,%s,%s,%s,%s,%s,%s)
                """,
                (event_id, tenant_id, ts, obj_type, obj_id, action,
                 payload, prev_hash, event_hash),
            )
            conn.commit()
            prev_hash = event_hash
        cur.close()
        conn.close()
        print("Seeded 3 audit events for tenant_ci_test")
        EOF
      env:
        PGURL: postgresql://cdil:cdil@localhost:5432/cdil
        PYTHONPATH: ${{ github.workspace }}

    - name: Run ledger integrity check against Postgres (seeded chain — PASS expected)
      run: |
        python tools/verify_ledger_integrity.py --engine postgres --pg-url "$PGURL" --json
      env:
        PGURL: postgresql://cdil:cdil@localhost:5432/cdil
        PYTHONPATH: ${{ github.workspace }}

    - name: Tamper with one audit event row
      run: |
        python3 - <<'EOF'
        import os, psycopg2
        conn = psycopg2.connect(os.environ["PGURL"])
        cur = conn.cursor()
        cur.execute(
            "UPDATE audit_events SET event_payload_json = '{\"tampered\": true}'"
            " WHERE object_id = 'note_1' AND tenant_id = 'tenant_ci_test'"
        )
        conn.commit()
        cur.close(); conn.close()
        print("Tampered note_1")
        EOF
      env:
        PGURL: postgresql://cdil:cdil@localhost:5432/cdil

    - name: Ledger integrity check after tamper (FAIL expected — exit code 1)
      run: |
        set +e
        ./tools/verify-ledger-integrity.sh --engine postgres --pg-url "$PGURL" --json
        EXIT=$?
        set -e
        if [[ $EXIT -ne 1 ]]; then
          echo "ERROR: Expected exit code 1 (tamper detected) but got $EXIT" >&2
          exit 1
        fi
        echo "Tamper detection confirmed: verifier correctly returned exit code 1."
      env:
    - name: Seed deterministic audit event chain via canonical hash logic
      run: |
        python - <<'PYEOF'
        import json
        import sys
        import os
        import uuid
        from datetime import datetime, timezone

        sys.path.insert(0, os.environ["PYTHONPATH"])
        from gateway.app.db.ledger_hashing import compute_event_hash

        import psycopg2
        pg_url = os.environ["PGURL"]
        conn = psycopg2.connect(pg_url)
        cur = conn.cursor()

        # Insert a tenant required by the FK constraint
        tenant_id = "ci-test-tenant-01"
        cur.execute(
            """
            INSERT INTO tenants (tenant_id, name, created_at_utc, updated_at_utc, status)
            VALUES (%s, %s, %s, %s, %s)
            ON CONFLICT (tenant_id) DO NOTHING
            """,
            (tenant_id, "CI Test Tenant", "2026-01-01T00:00:00Z", "2026-01-01T00:00:00Z", "active"),
        )

        # Insert a chain of 5 audit events using the canonical hash
        prev_hash = None
        for i in range(5):
            event_id = str(uuid.uuid4())
            ts = datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")
            obj_type, obj_id, action = "note", f"ci-note-{i}", "ci_create"
            payload_json = json.dumps({"ci_seq": i})
            event_hash = compute_event_hash(prev_hash, ts, obj_type, obj_id, action, payload_json)
            cur.execute(
                """
                INSERT INTO audit_events
                  (event_id, tenant_id, occurred_at_utc, actor_id,
                   object_type, object_id, action, event_payload_json,
                   prev_event_hash, event_hash)
                VALUES (%s, %s, %s, NULL, %s, %s, %s, %s, %s, %s)
                """,
                (event_id, tenant_id, ts, obj_type, obj_id, action, payload_json, prev_hash, event_hash),
            )
            prev_hash = event_hash

        conn.commit()
        cur.close()
        conn.close()
        print("Seeded 5 audit events with canonical hashes.")
        PYEOF
      env:
        PGURL: postgresql://cdil:cdil@localhost:5432/cdil
        PYTHONPATH: ${{ github.workspace }}

    - name: Verify seeded chain PASS
      run: |
        python tools/verify_ledger_integrity.py \
          --engine postgres --pg-url "$PGURL" \
          --tenant ci-test-tenant-01 --json | tee /tmp/verify_result.json
        python - <<'PYEOF'
        import json, sys
        r = json.load(open("/tmp/verify_result.json"))
        assert r["status"] == "PASS", f"Expected PASS, got: {r}"
        assert r["total_events"] == 5, f"Expected 5 events, got: {r['total_events']}"
        assert r["failure"] is None, f"Expected no failure, got: {r['failure']}"
        print(f"PASS: {r['total_events']} events verified.")
        PYEOF
      env:
        PGURL: postgresql://cdil:cdil@localhost:5432/cdil
        PYTHONPATH: ${{ github.workspace }}

    - name: Tamper one row and confirm verifier detects it (FAIL expected)
      run: |
        psql "$PG_URL" -c "
          UPDATE audit_events
          SET event_payload_json = '{\"tampered\": true}'
          WHERE tenant_id = 'ci-test-tenant-01'
          AND object_id = 'ci-note-2';
        "
        set +e
        python tools/verify_ledger_integrity.py \
          --engine postgres --pg-url "$PGURL" \
          --tenant ci-test-tenant-01 --json > /tmp/tamper_result.json
        EXIT_CODE=$?
        set -e
        python - <<'PYEOF'
        import json, sys
        r = json.load(open("/tmp/tamper_result.json"))
        assert r["status"] == "FAIL", f"Expected FAIL after tamper, got: {r}"
        assert r["failure"] is not None, "Expected failure details"
        assert "Hash mismatch" in r["failure"]["reason"], f"Wrong reason: {r['failure']}"
        print(f"PASS: Tamper correctly detected. Failure: {r['failure']}")
        PYEOF
        [ "$EXIT_CODE" -eq 1 ] || { echo "ERROR: expected exit 1, got $EXIT_CODE"; exit 1; }
      env:
        PG_URL: postgresql://cdil:cdil@localhost:5432/cdil
        PGURL: postgresql://cdil:cdil@localhost:5432/cdil
        PYTHONPATH: ${{ github.workspace }}

  smoke-test-local:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run local smoke test
      run: |
        chmod +x ./tools/smoke-test-local.sh
        ./tools/smoke-test-local.sh

  smoke-test-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Docker smoke test
      run: |
        chmod +x ./tools/smoke-test-docker.sh
        ./tools/smoke-test-docker.sh
